<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Rater - Multi Version</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>ğŸ“‹ Task Rater <span style="font-size:0.6em; color:#666;">(Multi-Version)</span></h2>
        <form method="POST" action="/" style="display:flex; gap:5px;">
            <input type="text" name="search_query" placeholder="Search Query or ID..." style="padding:8px; border-radius:4px; border:1px solid #ccc;">
            <button type="submit" class="btn-vote" style="background:#eee;">ğŸ”</button>
        </form>
    </div>

    {% if message %}
        <div class="msg">{{ message }}</div>
    {% endif %}

    <div class="card">
        <details>
            <summary style="cursor:pointer; font-weight:bold; color:#2563eb;">â• Paste New Task / Version</summary>
            <br>
            <form method="POST">
                <textarea name="raw_text" placeholder="Paste full text... If the task ID is the same, it will be added as a new version."></textarea>
                <button type="submit" class="btn-save">Process & Save</button>
            </form>
        </details>
    </div>

    {% for task in search_results %}
    <div class="card">
        
        <div class="task-header">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span class="task-id">{{ task.task_id }}</span>
                <span class="header-badge" style="background:#e0f2fe; color:#0369a1;">
                    {{ task.headers['Task Type'] }}
                </span>
            </div>
            <div class="query-text">{{ task.headers['Query'] }}</div>
            <div class="header-meta">
                <span class="header-badge">ğŸŒ {{ task.headers['Locale'] }}</span>
                <span class="header-badge">ğŸ“… {{ task.headers['Viewport Age'] }}</span>
                <span class="header-badge">ğŸ“ {{ task.headers['Lat, Lng'] }}</span>
            </div>
        </div>

        <div class="tab-header">
            {% for ver in task.versions %}
                <button class="tab-btn {{ 'active' if loop.first else '' }}" 
                        onclick="openTab(event, 'v-{{ ver.db_id }}', '{{ task.task_id }}')">
                    Version {{ loop.index }}
                </button>
            {% endfor %}
        </div>

        {% for ver in task.versions %}
        <div id="v-{{ ver.db_id }}" class="tab-content {{ 'active' if loop.first else '' }} group-{{ task.task_id }}">
            
            {% for res in ver.results %}
            
            {% set is_rated = (res.ratings|length > 0 and res.ratings[0].value != 'Not Rated' and res.ratings[0].value != '-') %}
            
            <div class="res-container {{ 'rated-item' if is_rated else '' }}">
                
                {% if is_rated %}
                <div class="vote-box">
                    <button class="btn-vote" onclick="vote({{ ver.db_id }}, {{ loop.index0 }}, 'up')">
                        ğŸ‘ <span id="up-{{ ver.db_id }}-{{ loop.index0 }}" style="color:#059669;">{{ res.upvotes }}</span>
                    </button>
                    <button class="btn-vote" onclick="vote({{ ver.db_id }}, {{ loop.index0 }}, 'down')">
                        ğŸ‘ <span id="down-{{ ver.db_id }}-{{ loop.index0 }}" style="color:#dc2626;">{{ res.downvotes }}</span>
                    </button>
                </div>
                {% endif %}

                <div class="res-content">
                    <div>
                        <span class="res-num">{{ res.num }}</span>
                        <span class="res-title">{{ res.title }}</span>
                    </div>
                    <div class="res-sub">{{ res.subtitle }}</div>
                    <div class="meta-tags">
                        {% for m in res.meta %}
                            <span class="tag"><b>{{ m.label }}:</b> {{ m.value }}</span>
                        {% endfor %}
                    </div>
                </div>

                {% if is_rated %}
                <div class="res-ratings">
                    {% for r in res.ratings %}
                        {% if r.value and r.value != '-' and r.value != 'None' and r.value != 'Not Rated' %}
                        <div class="rating-row">
                            <span class="r-label">{{ r.label }}</span>
                            {% if r.value.lower() == 'n/a' %}
                                <span class="r-val val-na">n/a</span>
                            {% else %}
                                <span class="r-val val-{{ r.value | replace(' ', '-') }}">{{ r.value }}</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}

            </div>
            {% endfor %} </div>
        {% endfor %} </div>
    {% endfor %} </div>

<script>
// Tab Switching Logic
function openTab(evt, tabId, groupName) {
    // 1. Hide all tabs in this specific group (Task ID)
    var contents = document.getElementsByClassName("group-" + groupName);
    for (var i = 0; i < contents.length; i++) {
        contents[i].classList.remove("active");
    }

    // 2. Remove 'active' class from buttons in this container
    // We navigate up to the parent (.tab-header) to find sibling buttons
    var buttons = evt.currentTarget.parentElement.getElementsByClassName("tab-btn");
    for (var i = 0; i < buttons.length; i++) {
        buttons[i].classList.remove("active");
    }

    // 3. Show the clicked tab and activate button
    document.getElementById(tabId).classList.add("active");
    evt.currentTarget.classList.add("active");
}

function vote(dbId, idx, type) {
    fetch('/vote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: dbId, idx: idx, type: type })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            document.getElementById(`up-${dbId}-${idx}`).innerText = data.up;
            document.getElementById(`down-${dbId}-${idx}`).innerText = data.down;
        }
    });
}
</script>

</body>
</html>