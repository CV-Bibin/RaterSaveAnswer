<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Rater Pro</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {{ firebase_config | tojson }};
        firebase.initializeApp(firebaseConfig);
    </script>

    <style>
        .res-body-row { display: flex; gap: 20px; align-items: flex-start; }
        .res-content { flex: 1; }
        .res-right-panel { width: 300px; border-left: 1px solid #e2e8f0; padding-left: 20px; display: flex; flex-direction: column; align-items: flex-end; }
        .res-ratings { width: 100%; display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .rating-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; border-bottom: 1px dashed #f1f5f9; padding-bottom: 4px; }
        .vote-box { display: flex; gap: 5px; margin-bottom: 5px; }
        .res-caution .res-right-panel { padding-top: 15px; }

        .query-text { font-size: 1.4em; font-weight: 700; color: #4f46e5; margin: 8px 0; background: #eef2ff; padding: 8px 12px; border-radius: 6px; display: inline-block; border-left: 4px solid #4f46e5; }
        .res-caution { border: 2px solid #ef4444 !important; background-color: #fff5f5; position: relative; }
        .res-caution::before { content: "‚ö†Ô∏è HIGH DISAGREEMENT"; position: absolute; top: 0; right: 0; background: #ef4444; color: white; font-size: 0.65em; padding: 2px 6px; border-bottom-left-radius: 4px; font-weight: bold; z-index: 10; }
        
        .rated-item { border-left: 5px solid #059669 !important; }
        .rated-item .res-num { background: #059669 !important; color: white !important; }
        .rated-item .res-title { color: #059669; }

        .action-bar { display: flex; gap: 8px; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #e2e8f0; clear: both; }
        .notes-section { margin-top: 10px; font-size: 0.85em; }
        .note-item { background: #fffbeb; border-left: 3px solid #f59e0b; padding: 4px 8px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; }
        .note-user { font-weight: bold; color: #d97706; margin-right: 5px; }
        .del-note-btn { color: #ef4444; font-weight: bold; cursor: pointer; margin-left: 8px; font-size: 1.1em; opacity: 0.7; }
        .del-note-btn:hover { opacity: 1; transform: scale(1.1); }
        .vote-active-up { background-color: #d1fae5 !important; border-color: #059669 !important; color: #065f46 !important; }
        .vote-active-down { background-color: #fee2e2 !important; border-color: #dc2626 !important; color: #991b1b !important; }
        .btn-mini { border: none; background: #f1f5f9; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75em; color: #64748b; display: flex; align-items: center; gap: 4px; }
        .edit-input { border: 1px solid #3b82f6; padding: 2px 4px; border-radius: 3px; width: 80px; font-size: 0.9em; text-align: right; }
    </style>
</head>
<body>

<div class="container">
   <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #e2e8f0;">
        <div style="display:flex; flex-direction:column; gap:5px;">
            <h2 style="margin:0;">üìã Task Rater <span style="font-size:0.5em; color:#64748b;">v4.5 (Fixed Scope)</span></h2>
            <div style="display:flex; align-items:center; gap:10px; background: #fff; padding: 4px 10px; border-radius: 20px; border: 1px solid #e2e8f0; width: fit-content;">
                <span id="user-display" style="font-size:0.8em; color:#2563eb; font-weight:bold;"></span>
                <span style="color: #cbd5e1;">|</span>
                <button onclick="logout()" style="border:none; background:none; color:#dc2626; cursor:pointer; font-size:0.8em; font-weight:600; padding:0;">Logout</button>
            </div>
        </div>
        
        <form method="POST" action="/?u={{ sanitized_user.replace(',', '.') }}" style="display:flex; gap:10px; align-items:center; background: #fff; padding: 6px 10px; border-radius: 30px; border: 1px solid #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <i class="fa-solid fa-magnifying-glass" style="color: #94a3b8; margin-left: 8px;"></i>
            <input type="text" name="search_query" placeholder="Search Task ID or Query..." style="border: none; outline: none; width: 260px; font-size: 0.95em; background: transparent; padding: 4px 0;">
            <button type="submit" style="background:#2563eb; color:white; border:none; padding:8px 18px; border-radius:20px; cursor:pointer; font-weight:600; font-size:0.85em;">Search</button>
            {% if is_search %}
                <a href="/?u={{ sanitized_user.replace(',', '.') }}" style="text-decoration:none; background:#f1f5f9; color:#ef4444; padding:8px 16px; border-radius:20px; font-size:0.85em; font-weight:bold; border: 1px solid #e2e8f0;">Back</a>
            {% endif %}
        </form>
    </div>

    <div class="card">
        <details>
            <summary style="cursor:pointer; font-weight:bold; color:#2563eb;">‚ûï Paste New Task</summary>
            <br><form method="POST"><input type="hidden" name="user_email" id="hidden_user_email"><textarea name="raw_text" placeholder="Paste task text..."></textarea><button type="submit" class="btn-save">Save</button></form>
        </details>
    </div>

    {% for task in search_results %}
    <div class="card">
        <div class="task-header">
            <div style="display:flex; justify-content:space-between;">
                <span class="task-id">{{ task.task_id }}</span>
                <span class="header-badge">{{ task.headers['Task Type'] }}</span>
            </div>
            <div class="query-text">{{ task.headers['Query'] }}</div>
            <div class="header-meta">
                <span class="header-badge">üåç {{ task.headers['Locale'] }}</span>
                <span class="header-badge">üìÖ {{ task.headers['Viewport Age'] }}</span>
                <span class="header-badge">üìç {{ task.headers['Lat, Lng'] }}</span>
            </div>
        </div>

       <div class="tab-header">
            {% for ver in task.versions %}
                {% set is_my_tab = (ver.author.lower() == sanitized_user.replace(',', '.').lower()) %}
                <button class="tab-btn {{ 'active' if loop.first else '' }}" 
                        onclick="openTab(event, 'v-{{ ver.db_id }}', '{{ task.task_id }}')"
                        style="{% if is_my_tab %}color: #059669; font-weight: bold;{% endif %}">
                    Ver {{ loop.index }} <small style="color:{% if is_my_tab %}#059669{% else %}#999{% endif %}">by {{ ver.author.split('@')[0] }}</small>
                </button>
            {% endfor %}
        </div>

        {% for ver in task.versions %}
        <div id="v-{{ ver.db_id }}" class="tab-content {{ 'active' if loop.first else '' }} group-{{ task.task_id }}">
            {% for res in ver.results %}
            {% set is_rated = (res.ratings|length > 0) %}
            {% set has_caution = (res.downvotes > res.upvotes) %}
            
            <div class="res-container {{ 'res-caution' if has_caution else '' }} {{ 'rated-item' if is_rated else '' }}" id="res-{{ ver.db_id }}-{{ loop.index0 }}">
                <div class="res-body-row">
                    <div class="res-content">
                        <div><span class="res-num">{{ res.num }}</span> <span class="res-title">{{ res.title }}</span></div>
                        <div class="res-sub">{{ res.subtitle }}</div>
                        <div class="meta-tags">{% for m in res.meta %}<span class="tag"><b>{{ m.label }}:</b> {{ m.value }}</span>{% endfor %}</div>
                    </div>
                    <div class="res-right-panel">
                        {% if is_rated %}
                        <div class="vote-box">
                             <button id="btn-up-{{ ver.db_id }}-{{ loop.index0 }}" class="btn-vote" onclick="vote('{{ task.task_id }}', '{{ ver.db_id }}', {{ loop.index0 }}, 'up')">üëç <span id="up-{{ ver.db_id }}-{{ loop.index0 }}">{{ res.upvotes }}</span></button>
                             <button id="btn-down-{{ ver.db_id }}-{{ loop.index0 }}" class="btn-vote" onclick="vote('{{ task.task_id }}', '{{ ver.db_id }}', {{ loop.index0 }}, 'down')">üëé <span id="down-{{ ver.db_id }}-{{ loop.index0 }}">{{ res.downvotes }}</span></button>
                        </div>
                        <div class="res-ratings" id="ratings-{{ ver.db_id }}-{{ loop.index0 }}">
                            {% for r in res.ratings %}
                                {% if r.value and r.value != '-' and r.value != 'None' %}
                                    <div class="rating-row" data-label="{{ r.label }}">
                                        <span class="r-label">{{ r.label }}</span>
                                        <span class="r-val val-{{ r.value | replace(' ', '-') }}">{{ r.value }}</span>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="action-bar">
                    <button class="btn-mini author-btn" data-author="{{ ver.author }}" style="display:none;" 
                            onclick="enableEdit('{{ task.task_id }}', '{{ ver.db_id }}', {{ loop.index0 }})">
                        <i class="fa-solid fa-pen"></i> Edit
                    </button>
                    <button class="btn-mini" onclick="toggleNoteBox('{{ ver.db_id }}', {{ loop.index0 }})">
                        <i class="fa-solid fa-comment"></i> Note
                    </button>
                </div>

               <div class="notes-section" id="notes-{{ ver.db_id }}-{{ loop.index0 }}">
                    {% if res.notes %}
                        {% for nid, note in res.notes.items() %}
                            <div class="note-item">
                                <div><span class="note-user">{{ note.user.split('@')[0] }}:</span> <span>{{ note.text }}</span></div>
                                {% if note.user.lower() == sanitized_user.replace(',', '.').lower() %}
                                    <span class="del-note-btn" onclick="deleteNote('{{ task.task_id }}', '{{ ver.db_id }}', {{ loop.index0 }}, '{{ nid }}')" title="Delete">√ó</span>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>

                <div id="note-input-{{ ver.db_id }}-{{ loop.index0 }}" style="display:none; margin-top:5px; gap:5px;">
                    <input type="text" id="txt-note-{{ ver.db_id }}-{{ loop.index0 }}" placeholder="Add comment..." style="flex:1; padding:4px; border:1px solid #ccc; font-size:0.85em;">
                    <button class="btn-mini" style="background:#3b82f6; color:white;" onclick="saveNote('{{ task.task_id }}', '{{ ver.db_id }}', {{ loop.index0 }})">Post</button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>

<script src="{{ url_for('static', filename='main.js') }}?v=1.2"></script>

<script>
    // 1. Convert Python task IDs into a JavaScript array
    const activeTasks = [
        {% for task in search_results %}
            "{{ task.task_id }}"{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    // 2. Handle Login & Pass Data to main.js
    firebase.auth().onAuthStateChanged((user) => {
        if (!user) {
            window.location.href = "/login";
        } else {
            const email = user.email.toLowerCase();
            const sanitizedKey = email.replaceAll('.', ',');
            
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('u') !== user.email) {
                window.location.href = "/?u=" + encodeURIComponent(user.email);
            }
            
            document.getElementById('hidden_user_email').value = user.email;
            document.getElementById('user-display').innerText = user.email;

            // Send data over to main.js to start the app safely
            initApp(email, sanitizedKey, activeTasks);
        }
    });

    function logout() { firebase.auth().signOut().then(() => window.location.href = "/login"); }
</script>
</body>
</html>